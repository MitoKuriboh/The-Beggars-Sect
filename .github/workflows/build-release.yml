# Build and Release Workflow for The Beggars Sect
# Triggers on:
#   - Push to main (build only)
#   - Git tags v* (build + release)
#   - Manual workflow dispatch

name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  NODE_VERSION: '20'
  APP_NAME: beggars-sect

jobs:
  # =============================================================================
  # BUILD EXECUTABLES
  # =============================================================================
  build:
    name: Build - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: node18-linux-x64
            artifact_name: beggars-sect-linux
            asset_name: beggars-sect-linux

          - os: macos-latest
            target: node18-macos-x64
            artifact_name: beggars-sect-macos
            asset_name: beggars-sect-macos

          - os: windows-latest
            target: node18-win-x64
            artifact_name: beggars-sect-win.exe
            asset_name: beggars-sect-win.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Package executable
        run: npx pkg . --target ${{ matrix.target }} --output dist/${{ matrix.artifact_name }} --compress GZip

      - name: Sign macOS executable (ad-hoc)
        if: matrix.os == 'macos-latest'
        run: codesign --sign - --force dist/${{ matrix.artifact_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}
          retention-days: 7

  # =============================================================================
  # CREATE LINUX DEB PACKAGE
  # =============================================================================
  build-deb:
    name: Build DEB Package
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux executable
        uses: actions/download-artifact@v4
        with:
          name: beggars-sect-linux
          path: dist/

      - name: Make executable
        run: chmod +x dist/beggars-sect-linux

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create DEB package structure
        run: |
          mkdir -p deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/DEBIAN
          mkdir -p deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/usr/local/bin
          mkdir -p deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/usr/share/doc/beggars-sect

          cp dist/beggars-sect-linux deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/usr/local/bin/beggars-sect
          chmod 755 deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/usr/local/bin/beggars-sect

      - name: Create control file
        run: |
          INSTALLED_SIZE=$(du -sk deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64 | cut -f1)
          cat > deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/DEBIAN/control << EOF
          Package: beggars-sect
          Version: ${{ steps.version.outputs.version }}
          Section: games
          Priority: optional
          Architecture: amd64
          Installed-Size: $INSTALLED_SIZE
          Maintainer: Mito <mito@genkaw.com>
          Homepage: https://beggars-sect.genkaw.com
          Description: A CLI RPG set in the Martial Arts Haven
           The Beggars Sect is a CLI-based Wuxia RPG following Li Wei,
           a mysterious figure who awakens with no memory.
          EOF

      - name: Create postinst script
        run: |
          cat > deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          echo "The Beggars Sect installed! Run 'beggars-sect' to play."
          EOF
          chmod 755 deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64/DEBIAN/postinst

      - name: Build DEB package
        run: |
          dpkg-deb --root-owner-group --build deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64
          mkdir -p installers
          mv deb-build/beggars-sect_${{ steps.version.outputs.version }}_amd64.deb installers/

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: beggars-sect-deb
          path: installers/*.deb
          retention-days: 7

  # =============================================================================
  # CREATE MACOS DMG
  # =============================================================================
  build-dmg:
    name: Build macOS DMG
    needs: build
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS executable
        uses: actions/download-artifact@v4
        with:
          name: beggars-sect-macos
          path: dist/

      - name: Make executable
        run: chmod +x dist/beggars-sect-macos

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create DMG content
        run: |
          mkdir -p dmg-content
          cp dist/beggars-sect-macos dmg-content/beggars-sect
          chmod +x dmg-content/beggars-sect

          # Sign executable (ad-hoc)
          codesign --sign - --force dmg-content/beggars-sect

          # Create README
          cat > dmg-content/README.txt << EOF
          The Beggars Sect v${{ steps.version.outputs.version }}

          Run in Terminal: ./beggars-sect
          Or copy to /usr/local/bin for global access.

          https://beggars-sect.genkaw.com
          EOF

      - name: Create DMG
        run: |
          mkdir -p installers
          hdiutil create -volname "The Beggars Sect" \
            -srcfolder dmg-content \
            -ov -format UDZO \
            installers/BeggarssSect-${{ steps.version.outputs.version }}-macOS.dmg

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: beggars-sect-dmg
          path: installers/*.dmg
          retention-days: 7

  # =============================================================================
  # CREATE GITHUB RELEASE
  # =============================================================================
  release:
    name: Create Release
    needs: [build, build-deb, build-dmg]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.create_release)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy executables
          cp artifacts/beggars-sect-linux/beggars-sect-linux release-assets/
          cp artifacts/beggars-sect-macos/beggars-sect-macos release-assets/
          cp artifacts/beggars-sect-win.exe/beggars-sect-win.exe release-assets/

          # Copy installers
          cp artifacts/beggars-sect-deb/*.deb release-assets/
          cp artifacts/beggars-sect-dmg/*.dmg release-assets/

          # List assets
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.version }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-assets/*
          body: |
            ## The Beggars Sect v${{ steps.version.outputs.version }}

            A CLI RPG set in the Martial Arts Haven

            ### Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | **Windows** | `beggars-sect-win.exe` | Standalone executable |
            | **macOS** | `BeggarssSect-${{ steps.version.outputs.version }}-macOS.dmg` | DMG installer |
            | **macOS** | `beggars-sect-macos` | Standalone executable |
            | **Linux** | `beggars-sect_${{ steps.version.outputs.version }}_amd64.deb` | Debian/Ubuntu package |
            | **Linux** | `beggars-sect-linux` | Standalone executable |

            ### Installation

            **Windows:** Run the `.exe` directly, or use the installer.

            **macOS:**
            - Mount the DMG and copy to Applications, OR
            - Download the executable, run `chmod +x beggars-sect-macos && ./beggars-sect-macos`

            **Linux (Debian/Ubuntu):**
            ```bash
            sudo dpkg -i beggars-sect_${{ steps.version.outputs.version }}_amd64.deb
            beggars-sect
            ```

            **Linux (Other):**
            ```bash
            chmod +x beggars-sect-linux
            ./beggars-sect-linux
            ```

            ### Website

            [beggars-sect.genkaw.com](https://beggars-sect.genkaw.com)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
